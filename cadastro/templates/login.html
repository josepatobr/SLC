{% load static %}
<html>
    <head>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <meta name="google-signin-client_id" content="325709064395-i6ekj4gdhrmradqgeulted7hno887f9q.apps.googleusercontent.com">
        
        <title>Login</title>
        <link href="{% static 'css/output.css' %}" rel="stylesheet">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
    </head>

    <body class="bg-gray-100 flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login</h2>
            
            <label for="opcao" class="block text-sm font-medium text-gray-700">Escolhe umas das formas de entradas:</label>
                <select id="opcao" name="opcao" class="mt-1 block w-full px-3 py-2 border rounded bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 flex text-center items-center justify-center">
                    <div class="text-center flex items-center justify-center">
                        <option  value="codigo-email">Entrar com código via email</option>
                        <option  value="codigo-sms">Entrar com código via sms (isso só serve se você adicionou o telefone no cadastro)</option>
                        <option  value="senha-email">Entrar com a senha e o email</option>
                    </div>
                </select>

            <div id="email-code-section" class="mt-4 hidden">
                <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="sms-code-section" class="mt-4 hidden">
                <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                <input type="tel" id="telefone" name="telefone" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div id="email-password-section" class="mt-4 hidden">
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="login-email" name="login-email" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                <label for="senha" class="block text-sm font-medium text-gray-700 mt-4">Senha:</label>
                <input type="password" id="senha" name="senha" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <br>
            <button id="enviar" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition duration-200">
                Entrar
            </button>


            <div id="sms-code-section" class="mt-4 hidden">
                <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                <input type="tel" id="code-telefone" name="telefone" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                <button id="enviar-sms" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enviar código por SMS
                </button>

                <div id="campo-codigo-sms" class="mt-4 hidden">
                    <label for="codigo-sms" class="block text-sm font-medium text-gray-700">Código recebido:</label>
                    <input type="text" id="codigo-sms" name="codigo-sms" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>


            <div id="email-code-section" class="mt-4 hidden">
                <label for="email" class="block text-sm font-medium text-gray-700">email:</label>
                <input type="email" id="code-email" name="email" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                <button id="enviar-email" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enviar código por email
                </button>

                <div id="campo-codigo-email" class="mt-4 hidden">
                    <label for="codigo-email" class="block text-sm font-medium text-gray-700">Código recebido:</label>
                    <input type="text" id="codigo-email" name="codigo-email" class="mt-1 block w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <br> 
            <br>
            <a href="/cadastro" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-600 text-center justify-center flex">
                cadastro
            </a>

            <br>


            <!-- GOOGLE -->
            <div id="g_id_onload"
                data-client_id="325709064395-i6ekj4gdhrmradqgeulted7hno887f9q.apps.googleusercontent.com"
                data-context="signin"
                data-callback="handleCredentialResponse"
                data-itp_support="true">
            </div>

            <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="outline"
                data-text="signin_with"
                data-size="large"
                data-logo_alignment="left">
            </div>
        </div>
    </body>
</html>

<script>
    function handleCredentialResponse(response){
        const jwt = response.credential;
        console.log("Token jwt recebido", jwt);

        fetch('http://localhost:8000/api/auth/login-google/',{ 
        method: 'POST',
        headers: {
            'Content-Type':'application/json'
        },
        body: JSON.stringify({ token:jwt})
        })
        .then(res=>res.json())
        .then(data=> {
            console.log("Resposta do backend:", data);
        })
        .catch(err => {
        console.error("Erro ao enviar token:", err);
      });
    }
    
    
    const select = document.getElementById("opcao");
    const emailCodeSection = document.getElementById("email-code-section");
    const smsCodeSection = document.getElementById("sms-code-section");
    const emailPasswordSection = document.getElementById("email-password-section");

    function atualizarSecao() {
        const value = select.value;

        emailCodeSection.classList.add("hidden");
        smsCodeSection.classList.add("hidden");
        emailPasswordSection.classList.add("hidden");

        if (value === "codigo-email") {
        emailCodeSection.classList.remove("hidden");
        } else if (value === "codigo-sms") {
        smsCodeSection.classList.remove("hidden");
        } else if (value === "senha-email") {
        emailPasswordSection.classList.remove("hidden");
        }
    }

    select.addEventListener("change", atualizarSecao);
    window.addEventListener("DOMContentLoaded", atualizarSecao);



    const enviarBtn = document.getElementById("enviar");

    enviarBtn.addEventListener("click", () => {
    const modo = document.getElementById("opcao").value;
    let payload = {};
    let endpoint = "";

    if (modo === "codigo-email") {
        const email = document.getElementById("email").value;
        payload = { email };
        endpoint = "/login-email-codigo";
    } else if (modo === "codigo-sms") {
        const telefone = document.getElementById("telefone").value;
        const codigo = prompt("Digite o código recebido por SMS:");
        payload = { telefone, codigo };
        endpoint = "/login-sms";
    } else if (modo === "senha-email") {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("senha").value;
        payload = { email, password };
        endpoint = "/login-email-codigo";
    }

    fetch(`http://localhost:8000${endpoint}`, {
        method: "POST",
        headers: {
        "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        console.log("Resposta do backend:", data);
    })
    .catch(err => {
        console.error("Erro ao enviar:", err);
    });
    });

    const enviarSMSBtn = document.getElementById("enviar-sms");
    const campoCodigoSMS = document.getElementById("campo-codigo-sms");

    
    
    enviarSMSBtn.addEventListener("click", () => {
    const telefone = document.getElementById("code-telefone").value;

    if (!telefone) {
        alert("Digite seu telefone primeiro.");
        return;
    }

    fetch("/enviar-codigo-sms", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ telefone })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Código enviado:", data);
    });
  

    campoCodigoSMS.classList.remove("hidden");
    
});

    const enviarEMAILBtn = document.getElementById("enviar-email");
    const campoCodigoEmail = document.getElementById("campo-codigo-email");

    enviarEMAILBtn.addEventListener("click", () => {
    const email = document.getElementById("code-email").value;

    if (!email) {
        alert("Digite seu email primeiro.");
        return;
    }

    fetch("/enviar-codigo-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Código enviado:", data);
    });

    campoCodigoEmail.classList.remove("hidden");
});

</script>